generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-arm64-openssl-1.1.x", "linux-musl-arm64-openssl-3.0.x", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String         @id @default(uuid())
  email         String         @unique
  firebaseUid   String?        @unique
  password      String?
  name          String
  avatar        String?
  description   String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  activities    Activity[]
  createdBoards Board[]
  boards        BoardMember[]
  assignedTasks TaskAssignee[]
  notifications Notification[]

  @@index([email])
}

model Board {
  id          String        @id @default(uuid())
  title       String
  description String?
  createdById String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  activities  Activity[]
  createdBy   User          @relation(fields: [createdById], references: [id], onDelete: Cascade)
  members     BoardMember[]
  lists       List[]

  @@index([createdById])
  @@index([title])
}

model BoardMember {
  id       String   @id @default(uuid())
  boardId  String
  userId   String
  role     Role     @default(MEMBER)
  joinedAt DateTime @default(now())
  board    Board    @relation(fields: [boardId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([boardId, userId])
  @@index([boardId])
  @@index([userId])
}

model List {
  id        String   @id @default(uuid())
  title     String
  position  Int
  boardId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  board     Board    @relation(fields: [boardId], references: [id], onDelete: Cascade)
  tasks     Task[]

  @@index([boardId])
  @@index([position])
  @@index([boardId, position])
}

model Task {
  id          String         @id @default(uuid())
  title       String
  description String?
  position    Int
  listId      String
  dueDate     DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  list        List           @relation(fields: [listId], references: [id], onDelete: Cascade)
  assignees   TaskAssignee[]

  @@index([listId])
  @@index([position])
  @@index([listId, position])
}

model TaskAssignee {
  id         String   @id @default(uuid())
  taskId     String
  userId     String
  assignedAt DateTime @default(now())
  task       Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([taskId, userId])
  @@index([taskId])
  @@index([userId])
}

model Activity {
  id         String     @id @default(uuid())
  action     ActionType
  entityType String
  entityId   String
  metadata   Json?
  userId     String
  boardId    String
  createdAt  DateTime   @default(now())
  board      Board      @relation(fields: [boardId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([boardId])
  @@index([userId])
  @@index([createdAt])
}

enum Role {
  ADMIN
  MEMBER
}

enum ActionType {
  BOARD_CREATED
  BOARD_UPDATED
  BOARD_DELETED
  LIST_CREATED
  LIST_UPDATED
  LIST_DELETED
  TASK_CREATED
  TASK_UPDATED
  TASK_MOVED
  TASK_DELETED
  TASK_ASSIGNED
  TASK_UNASSIGNED
  MEMBER_ADDED
  MEMBER_REMOVED
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  title     String
  message   String
  type      String   @default("info")
  read      Boolean  @default(false)
  link      String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}
